<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Debug - Electrotrack</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 20px auto; padding: 20px; }
        button { padding: 10px 20px; font-size: 16px; margin: 10px 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warning { color: orange; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .duplicate { background-color: #ffeeee; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <h1>üîß Transaction Debug Tool</h1>
    <p>Use this tool to diagnose and fix transaction data issues.</p>
    
    <div style="background: #fff3cd; padding: 15px; border: 1px solid #ffeaa7; border-radius: 4px; margin-bottom: 20px;">
        <strong>‚ö†Ô∏è Important:</strong> This tool works with your local browser storage. Make sure to backup any important data before making changes.
    </div>

    <div>
        <button onclick="analyzeTransactions()">üîç Analyze Transactions</button>
        <button onclick="fixDuplicateIds()">üîß Fix Duplicate IDs</button>
        <button onclick="showAllTransactions()">üìã Show All Transactions</button>
        <button onclick="clearAllTransactions()">üóëÔ∏è Clear All Transactions</button>
        <button onclick="generateSampleData()">üìä Add Sample Data</button>
    </div>
    
    <div id="output"></div>

    <script>
        function getStoredTransactions() {
            const stored = localStorage.getItem('radhika_transactions');
            return stored ? JSON.parse(stored) : [];
        }

        function saveTransactions(transactions) {
            localStorage.setItem('radhika_transactions', JSON.stringify(transactions));
        }

        function analyzeTransactions() {
            const output = document.getElementById('output');
            const transactions = getStoredTransactions();
            
            if (transactions.length === 0) {
                output.innerHTML = '<div class="info">üìù No transactions found in localStorage.</div>';
                return;
            }

            // Check for duplicates
            const idCounts = {};
            const duplicates = [];
            
            transactions.forEach((t, index) => {
                if (idCounts[t.id]) {
                    idCounts[t.id].push({ ...t, index });
                    if (idCounts[t.id].length === 2) {
                        duplicates.push(t.id);
                    }
                } else {
                    idCounts[t.id] = [{ ...t, index }];
                }
            });

            // Generate stats
            const stats = {
                total: transactions.length,
                duplicateIds: duplicates.length,
                uniqueIds: Object.keys(idCounts).length,
                income: transactions.filter(t => t.type === 'income').length,
                expense: transactions.filter(t => t.type === 'expense').length,
                totalRevenue: transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0),
                totalExpenses: transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0)
            };

            let html = '<h2>üìä Transaction Analysis</h2>';
            
            html += '<div class="stats">';
            html += '<div class="stat-card"><strong>Total Transactions:</strong><br>' + stats.total + '</div>';
            html += '<div class="stat-card"><strong>Unique IDs:</strong><br>' + stats.uniqueIds + '</div>';
            html += '<div class="stat-card ' + (stats.duplicateIds > 0 ? 'duplicate' : '') + '"><strong>Duplicate IDs:</strong><br>' + stats.duplicateIds + '</div>';
            html += '<div class="stat-card"><strong>Income Transactions:</strong><br>' + stats.income + '</div>';
            html += '<div class="stat-card"><strong>Expense Transactions:</strong><br>' + stats.expense + '</div>';
            html += '<div class="stat-card"><strong>Total Revenue:</strong><br>‚Çπ' + stats.totalRevenue.toLocaleString() + '</div>';
            html += '</div>';

            if (duplicates.length > 0) {
                html += '<div class="error">‚ùå Found ' + duplicates.length + ' duplicate IDs!</div>';
                html += '<h3>Duplicate Transactions:</h3>';
                html += '<table><tr><th>ID</th><th>Description</th><th>Amount</th><th>Date</th><th>Count</th></tr>';
                
                duplicates.forEach(duplicateId => {
                    const dupes = idCounts[duplicateId];
                    dupes.forEach((t, i) => {
                        html += '<tr class="duplicate">' +
                            '<td>' + t.id + '</td>' +
                            '<td>' + t.description + '</td>' +
                            '<td>‚Çπ' + t.amount + '</td>' +
                            '<td>' + t.date + '</td>' +
                            '<td>' + dupes.length + '</td>' +
                        '</tr>';
                    });
                });
                html += '</table>';
            } else {
                html += '<div class="success">‚úÖ No duplicate IDs found!</div>';
            }

            output.innerHTML = html;
        }

        function fixDuplicateIds() {
            const output = document.getElementById('output');
            const transactions = getStoredTransactions();
            
            if (transactions.length === 0) {
                output.innerHTML = '<div class="info">üìù No transactions to fix.</div>';
                return;
            }

            const seenIds = new Set();
            const fixedTransactions = [];
            let fixedCount = 0;
            
            transactions.forEach((transaction, index) => {
                if (seenIds.has(transaction.id)) {
                    // Generate new unique ID for duplicate
                    const timestamp = Date.now() + index; // Add index to ensure uniqueness
                    const randomSuffix = Math.random().toString(36).substring(2, 8);
                    const newId = timestamp + '-' + randomSuffix;
                    
                    fixedTransactions.push({
                        ...transaction,
                        id: newId
                    });
                    seenIds.add(newId);
                    fixedCount++;
                } else {
                    fixedTransactions.push(transaction);
                    seenIds.add(transaction.id);
                }
            });

            if (fixedCount > 0) {
                saveTransactions(fixedTransactions);
                output.innerHTML = '<div class="success">‚úÖ Fixed ' + fixedCount + ' duplicate IDs! Refresh the admin panel to see the changes.</div>';
            } else {
                output.innerHTML = '<div class="success">‚úÖ No duplicate IDs found to fix.</div>';
            }
        }

        function showAllTransactions() {
            const output = document.getElementById('output');
            const transactions = getStoredTransactions();
            
            if (transactions.length === 0) {
                output.innerHTML = '<div class="info">üìù No transactions found.</div>';
                return;
            }

            let html = '<h2>üìã All Transactions (' + transactions.length + ')</h2>';
            html += '<table><tr><th>ID</th><th>Description</th><th>Type</th><th>Amount</th><th>Category</th><th>Date</th></tr>';
            
            transactions
                .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())
                .forEach(t => {
                    html += '<tr>' +
                        '<td style="font-family: monospace; font-size: 11px;">' + t.id + '</td>' +
                        '<td>' + t.description + '</td>' +
                        '<td>' + t.type + '</td>' +
                        '<td>‚Çπ' + t.amount + '</td>' +
                        '<td>' + t.category + '</td>' +
                        '<td>' + new Date(t.date).toLocaleDateString() + '</td>' +
                    '</tr>';
                });
            html += '</table>';
            
            output.innerHTML = html;
        }

        function clearAllTransactions() {
            if (confirm('‚ö†Ô∏è Are you sure you want to delete ALL transactions? This cannot be undone!')) {
                localStorage.removeItem('radhika_transactions');
                document.getElementById('output').innerHTML = '<div class="success">‚úÖ All transactions cleared!</div>';
            }
        }

        function generateSampleData() {
            const output = document.getElementById('output');
            const currentTransactions = getStoredTransactions();
            
            const sampleTransactions = [
                {
                    id: Date.now() + '-sample1',
                    description: 'Samsung TV Sale',
                    amount: 32999,
                    category: 'Sales',
                    type: 'income',
                    date: new Date().toISOString().split('T')[0],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                },
                {
                    id: Date.now() + '-sample2',
                    description: 'Store Rent',
                    amount: 25000,
                    category: 'Rent',
                    type: 'expense',
                    date: new Date().toISOString().split('T')[0],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                }
            ];

            const updatedTransactions = [...sampleTransactions, ...currentTransactions];
            saveTransactions(updatedTransactions);
            
            output.innerHTML = '<div class="success">‚úÖ Added 2 sample transactions!</div>';
        }

        // Auto-analyze on page load
        window.addEventListener('load', () => {
            analyzeTransactions();
        });
    </script>
</body>
</html>
